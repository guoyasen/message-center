<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.iquantex.tspweb.dao.java.TspUserMapper">
  <resultMap id="BaseResultMap" type="com.iquantex.tspweb.model.TspUser">
    <!--
      WARNING - @mbg.generated
    -->
    <id column="ID" jdbcType="DECIMAL" property="id" />
    <result column="USER_ID" jdbcType="DECIMAL" property="userId" />
    <result column="ROLE_ID" jdbcType="VARCHAR" property="roleId" />
    <result column="USER_NAME" jdbcType="VARCHAR" property="userName" />
    <result column="PASSWORD" jdbcType="VARCHAR" property="password" />
  </resultMap>

  <select id="queryTspUserInfo" resultType="com.iquantex.tspweb.model.TspUser">
    select *  FROM tsp_user  WHERE user_id = #{user_id}
  </select>

  <select id="selectUidByRoleId" resultType="String">
    SELECT user_id FROM tsp_user u
    WHERE u.role_id = #{roleId}
  </select>

  <select id="selectUidByMenuitemId" resultType="String">
    SELECT USER_ID FROM TSP_USER
    WHERE ROLE_ID IN (
      SELECT ROLE_ID FROM TSP_ROLE
    WHERE AUTHORIZATION LIKE concat(#{mid},',%') OR AUTHORIZATION LIKE concat('%,',#{mid}) OR AUTHORIZATION LIKE concat(concat('%,',#{mid}),',%')
    )
  </select>

  <update id="updateTspUser" parameterType="com.iquantex.tspweb.model.TspUser">
    update tsp_user
    <trim prefix="set" suffixOverrides=",">
      <!--<if test="userId != null">USER_ID=#{userId},</if>-->
      <if test="roleId != null">ROLE_ID=#{roleId},</if>
      <if test="userName != null">USER_NAME=#{userName},</if>
      <if test="password != null">PASSWORD=#{password},</if>
    </trim>
    where id=#{id}
  </update>

  <insert id="insertTspUser" parameterType="com.iquantex.tspweb.model.TspUser" flushCache="true">
    INSERT  into tsp_user
    (ID, USER_ID, ROLE_ID, USER_NAME, PASSWORD)
    VALUES(
    #{id,jdbcType=DECIMAL},
    #{userId,jdbcType = VARCHAR},
    #{roleId,jdbcType = VARCHAR},
    #{userName,jdbcType = VARCHAR},
    #{password,jdbcType = VARCHAR}
    )
  </insert>

  <select id="selectUserByUserId" resultType="com.iquantex.tspweb.model.TspUserTree">
    select to_char(USER_ID) as id,
    USER_NAME as name ,
    DEPARTMENT_ID as  pid from tsp_user
    <if test=" user_id != null">
      where DEPARTMENT_ID in(select DEPARTMENT_ID from tsp_user where user_id=#{user_id}) or
      (select count(*) from tsp_user_role where user_id=#{user_id} and role_id=1)>=1
    </if>
    union
    select  to_char( DEPARTMENT_ID) as id,
    DEPARTMENT_NAME as name,
    '0' as pid from tsp_department
    <if test=" user_id != null">
      where DEPARTMENT_ID in(select DEPARTMENT_ID from tsp_user where user_id=#{user_id}) or
      (select count(*) from tsp_user_role where user_id=#{user_id} and role_id=1)>=1
    </if>
  </select>

</mapper>